Bootstrap: docker
From: nvidia/cuda:12.8.0-cudnn-devel-ubuntu22.04

%post
    echo "Installing system packages..."
    apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    python3-dev python3-pip python3-setuptools git g++ wget make libprotobuf-dev protobuf-compiler libopencv-dev \
    libgoogle-glog-dev libboost-all-dev libhdf5-dev libatlas-base-dev ffmpeg linux-libc-dev && \
    rm -rf /var/lib/apt/lists/*

    echo "Installing Python dependencies..."
    pip3 install --upgrade pip
    pip3 install numpy opencv-python

    echo "Installing CMake 3.28.0 from Kitware APT repository..."
    # Install CMake from Kitware's official APT repository for a more reliable install
    apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends ca-certificates gpg wget && \
    wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | gpg --dearmor - | tee /usr/share/keyrings/kitware-archive-keyring.gpg >/dev/null && \
    echo 'deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ jammy main' | tee /etc/apt/sources.list.d/kitware.list >/dev/null && \
    apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends cmake && \
    rm -rf /var/lib/apt/lists/*
    
    # Verify CMake installation
    echo "Verifying CMake installation..."
    cmake --version

%environment
    export PATH="/usr/bin:${PATH}"

%labels
    Author @hiibolt on GitHub
    Version 1.0
    Description Base image with CUDA, packages, and CMake for OpenPose
